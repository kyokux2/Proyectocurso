# Proyectocurso
# Subscription Platform MVP

## Описание проекта
Данный проект представляет собой MVP подписочной платформы с поддержкой:
- оформления подписок,
- автоматического продления,
- обработки успешных и неуспешных платежей,
- хранения истории транзакций (ledger),
- идемпотентности операций.

Проект разработан как учебный MVP с фокусом на бизнес-логику и архитектурные решения.

---

## Функциональные возможности
- Создание и управление тарифными планами
- Оформление подписки пользователем
- Fake-платёжный шлюз (симуляция оплаты)
- Автоматическое продление подписок
- Обработка ошибок оплаты
- История транзакций пользователя
- Идемпотентная логика платежей
- Проверка состояния подписки через API

---

## Архитектура решения
Для MVP была выбрана архитектура **модульного монолита**, что позволило:
- сократить время разработки,
- сохранить читаемость и расширяемость кода,
- упростить деплой и тестирование.

### Основные модули:
- `users` — управление пользователями
- `plans` — тарифные планы
- `subscriptions` — жизненный цикл подписок
- `payments` — логика оплаты (fake gateway)
- `renewals` — автоматическое продление
- `transactions` — ledger платежей

---

## Технологический стек
- Python 3
- FastAPI
- PostgreSQL
- SQLAlchemy
- Docker / Docker Compose
- Swagger (OpenAPI)

---

## Основные API эндпоинты

- `GET /health` — проверка состояния сервиса
- `GET /plans` — получение списка тарифов
- `POST /subscribe` — оформление подписки
- `GET /me/subscription` — текущее состояние подписки
- `GET /me/transactions` — история транзакций
- `POST /internal/run-renewals` — триггер автоматического продления

---

## Автоматическое продление подписок
Механизм продления:
1. Система ищет активные подписки с истёкшим периодом.
2. Выполняется попытка списания средств.
3. При успехе — период подписки продлевается.
4. При ошибке — подписка переводится в состояние `PAST_DUE`.
5. Все операции фиксируются в журнале транзакций.

---

## Идемпотентность
Каждый платёж выполняется с использованием `idempotency_key`, что предотвращает:
- повторные списания,
- дублирование транзакций,
- проблемы при повторных запросах.

---

## Обработка edge cases
- Недоступность платёжного шлюза (симуляция)
- Повторные запросы оплаты
- Истёкший период подписки
- Ошибки при автоматическом продлении

---

## Ограничения MVP
В рамках MVP осознанно не реализованы:
- реальная платёжная система,
- cron-задачи (используется ручной триггер),
- frontend-интерфейс,
- система уведомлений.

Архитектура проекта позволяет добавить данные компоненты без изменения core-логики.

---

## Запуск проекта

```bash
docker-compose up -d
uvicorn app.main:app --reload

Pytonproyect
